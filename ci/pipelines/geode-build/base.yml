#
# Licensed to the Apache Software Foundation (ASF) under one or more
# contributor license agreements.  See the NOTICE file distributed with
# this work for additional information regarding copyright ownership.
# The ASF licenses this file to You under the Apache License, Version 2.0
# (the "License"); you may not use this file except in compliance with
# the License.  You may obtain a copy of the License at
#
#      http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#

---

resource_types:
  - name: gcs-resource
    type: docker-image
    source:
      repository: frodenas/gcs-resource
resources:
- name: docker-geode-build-image
  type: docker-image
  source:
    username: ((!docker-username))
    password: ((!docker-password))
    repository: gcr.io/apachegeode-ci/((!docker-image-name))
    tag: latest
- name: geode
  type: git
  source:
    uri: (( concat "https://github.com/" metadata.geode-fork "/geode.git" ))
    branch: (( grab metadata.geode-build-branch ))
    ignore_paths:
    - ci/*
- name: geode-ci
  type: git
  source:
    depth: 1
    uri: (( concat "https://github.com/" metadata.geode-fork "/geode.git" ))
    branch: (( grab metadata.geode-build-branch ))
    paths:
    - ci/*
- name: geode-build-version
  type: semver
  source:
    driver: gcs
    bucket: ((!concourse-bucket))
    key: (( concat metadata.geode-build-branch "/version" ))
    json_key: ((!concourse-gcp-key))
    initial_version: 1.3.0

groups:
- name: main
  jobs:
  - DistributedTest

jobs:
- name: DistributedTest
  serial: true
  public: true
  plan:
    - aggregate:
      - get: geode
      - get: geode-ci
      - get: geode-build-version
      - get: docker-geode-build-image
        params:
          rootfs: true
    - aggregate:
      - task: run-distributed
        image: docker-geode-build-image
        tags: [svelte]
        privileged: true
        timeout: 12h
        config:
          inputs:
            - name: geode
            - name: geode-ci
            - name: docker-geode-build-image
            - name: geode-build-version
          platform: linux
          outputs:
            - name: built-geode
          params:
            MAINTENANCE_VERSION: (( grab metadata.geode-build-branch ))
            SERVICE_ACCOUNT: ((!concourse-gcp-account))
            PUBLIC_BUCKET: ((!public-bucket))
            PARALLEL_DUNIT: true
            DUNIT_PARALLEL_FORKS: 7
            CALL_STACK_TIMEOUT: 39600
          run:
            args:
            - distributedTest
            - distributedtest
            path: geode-ci/ci/scripts/test-run.sh
        ensure:
          aggregate:
          - task: archive-results-everythingelse
            image: docker-geode-build-image
            config:
              inputs:
                - name: geode
                - name: geode-ci
                - name: geode-build-version
                - name: built-geode
              platform: linux
              params:
                MAINTENANCE_VERSION: (( grab metadata.geode-build-branch ))
                SERVICE_ACCOUNT: ((!concourse-gcp-account))
                PUBLIC_BUCKET: ((!public-bucket))
              run:
                args:
                - disitributedTest
                - distributedtesteverythingelse
                path: geode-ci/ci/scripts/test-archive.sh
